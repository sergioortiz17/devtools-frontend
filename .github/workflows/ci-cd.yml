name: Frontend CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      build_image:
        description: 'Build and push Docker image'
        required: false
        default: 'true'
        type: boolean
      deploy_dev:
        description: 'Deploy to dev cluster'
        required: false
        default: 'false'
        type: boolean

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: 002419998824.dkr.ecr.us-east-1.amazonaws.com
  IMAGE_REPO: devtools-frontend
  HELM_CHART_REPO: helm-charts/devtools-playground
  HELM_CHART_NAME: devtools-playground
  SONAR_ORG: sergioortiz17
  SONAR_PROJECT_KEY: sergioortiz17_devtools-frontend

jobs:
  # Job 0: SonarCloud Code Analysis
  sonarcloud-analysis:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    if: |
      github.event_name == 'push' ||
      github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Node.js dependencies
        run: |
          npm install

      - name: Run JavaScript tests with coverage
        run: |
          npm run test:coverage || true
        continue-on-error: true

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: .
          args: >
            -Dsonar.organization=${{ env.SONAR_ORG }}
            -Dsonar.projectKey=${{ env.SONAR_PROJECT_KEY }}
            -Dsonar.host.url=https://sonarcloud.io
            -Dsonar.sources=src
            -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/build/**,**/coverage/**,**/*.test.js,**/*.test.jsx,**/*.spec.js,**/*.spec.jsx
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.sourceEncoding=UTF-8
            -Dsonar.test.exclusions=**/*.test.js,**/*.test.jsx,**/*.spec.js,**/*.spec.jsx
            -Dsonar.language=js
            -Dsonar.github.repository=${{ github.repository }}
            -Dsonar.github.oauth=${{ secrets.GITHUB_TOKEN }}
            -Dsonar.branch.name=${{ github.event_name == 'pull_request' && github.head_ref || github.ref_name }}
            -Dsonar.branch.target=${{ github.event_name == 'pull_request' && github.base_ref || github.ref_name }}

  # Job 1: Build and push Docker image
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: sonarcloud-analysis
    permissions:
      id-token: write
      contents: read
    if: |
      (github.event_name == 'workflow_dispatch' && inputs.build_image == true) ||
      (github.event_name == 'push' && (needs.sonarcloud-analysis.result == 'success' || needs.sonarcloud-analysis.result == 'failure' || needs.sonarcloud-analysis.result == 'skipped'))
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::002419998824:role/github-actions-devtools-playground
          role-session-name: GitHubActions-Frontend-Build
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate image tags
        id: image-tags
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          BRANCH_NAME=${BRANCH_NAME//\//-}
          
          TAG="$SHORT_SHA"
          
          if [ "$BRANCH_NAME" != "main" ]; then
            TAG="$TAG,$BRANCH_NAME"
          fi
          
          if [ "$BRANCH_NAME" == "main" ]; then
            TAG="$TAG,latest"
          fi
          
          echo "tags=$TAG" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          build-args: |
            VITE_API_URL=/api
            VITE_APP_VERSION=${{ steps.image-tags.outputs.short_sha }}
          tags: |
            ${{ env.ECR_REGISTRY }}/${{ env.IMAGE_REPO }}:${{ steps.image-tags.outputs.short_sha }}
            ${{ env.ECR_REGISTRY }}/${{ env.IMAGE_REPO }}:latest
          cache-from: type=registry,ref=${{ env.ECR_REGISTRY }}/${{ env.IMAGE_REPO }}:buildcache
          cache-to: type=registry,ref=${{ env.ECR_REGISTRY }}/${{ env.IMAGE_REPO }}:buildcache,mode=max

      - name: Output image URL
        run: |
          echo "## ðŸ³ Docker Image Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.ECR_REGISTRY }}/${{ env.IMAGE_REPO }}:${{ steps.image-tags.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.ECR_REGISTRY }}/${{ env.IMAGE_REPO }}:latest\`" >> $GITHUB_STEP_SUMMARY

  # Job 2: Deploy to dev cluster
  deploy-dev:
    name: Deploy Frontend to Dev Cluster
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      id-token: write
      contents: read
    if: |
      github.event_name == 'workflow_dispatch' && inputs.deploy_dev == true ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::002419998824:role/github-actions-devtools-playground
          role-session-name: GitHubActions-Frontend-Deploy
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'

      - name: Configure kubeconfig
        run: |
          aws eks update-kubeconfig --name vn-dev-eks --region ${{ env.AWS_REGION }}

      - name: Authenticate Helm with ECR
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
            helm registry login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}

      - name: Get short SHA
        id: sha
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Deploy to EKS
        run: |
          echo "## ðŸš€ Deploying Frontend to EKS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deploying with image tag: \`${{ steps.sha.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          helm upgrade --install ${{ env.HELM_CHART_NAME }} \
            oci://${{ env.ECR_REGISTRY }}/${{ env.HELM_CHART_REPO }} \
            --version 1.0.0 \
            --namespace devtools-playground \
            --create-namespace \
            --values helm/values-vn-dev.yaml \
            --set frontend.image.tag=${{ steps.sha.outputs.short_sha }} \
            --wait \
            --timeout 10m
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Frontend deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ Application URL: https://app.dryvn.org" >> $GITHUB_STEP_SUMMARY

      - name: Verify deployment
        run: |
          kubectl get pods -n devtools-playground -l app.kubernetes.io/component=frontend
          kubectl rollout status deployment/devtools-playground-frontend -n devtools-playground

